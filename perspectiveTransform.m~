%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%function Im = perspectiveTransform()
%
%Receives an original image and uses perpective transformation to transform it to
%a straight, readable image.
%Returns straight, grayscale image.
%Part of a pattern recognition project TNM034 - Advanced Image Processing, Linköping
%University HT2014.
%
%Copyright (c) <2014> Karolin Jonsson, Louise Carlström, Linnea Nåbo, Linnea Mellblom
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function transformed = perspectiveTransform(Im, fips, ap)

% The fip points of the distorted image 
moving_points = [fips(1,2) fips(1,1);
                    fips(2,2) fips(2,1);
                        fips(3,2) fips(3,1);
                            ap(2) ap(1)];

    % A-------C
    % |    _/
    % |  _/
    % |_/
    % B/

% Receive the vectors 
A = fips(2,:);
B = fips(1,:);
C = fips(3,:);

AC = C-A;
AB = B-A;
    
% Calculate true values
% Find max distance:
dist_1 = sqrt(AC(1)^2 + AC(2)^2);
dist_2 = sqrt(AB(1)^2 + AB(2)^2); 

dist_max = max(dist_1, dist_2);
cell_width = dist_max/34;
dist_min = 3.5*cell_width;
side = 41*cell_width;
dist_fip = 37.5*cell_width;
dist_ap = 34.5*cell_width;

fixed_points = [dist_min dist_fip;
                    dist_min dist_min;
                        dist_fip dist_min;
                            dist_ap dist_ap];

tform = fitgeotrans(moving_points, fixed_points, 'projective');
newim = imwarp(Im, tform, 'linear');

% 
newim = im2binarySimple(newim);
% find FIPs
FIPCandidates = findFIPCandidates(newim);
FIPLocations = findFIPs(FIPCandidates);


rect = [FIPLocations(2,2)-(3.5*cell_width) FIPLocations(2,1)-(3.5*cell_width) side side];
newim = imcrop(newim, rect);

transformed = newim;

